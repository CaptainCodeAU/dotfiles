# ====================================
# ComfyUI Configuration for WSL/ZSH
# With LAN Support (FIXED VERSION)
# ====================================

# ComfyUI paths
export COMFYUI_ROOT="/mnt/e/ComfyUI_windows_portable"
export COMFYUI_PYTHON="$COMFYUI_ROOT/python_embeded/python.exe"
export COMFYUI_SCRIPTS="$COMFYUI_ROOT/python_embeded/Scripts"

# Add Python Scripts to PATH (for tools installed via pip)
export PATH="$COMFYUI_SCRIPTS:$PATH"

# Aliases for ComfyUI
alias comfyui='bash /mnt/e/ComfyUI_windows_portable/comfyui_launch_lan.sh'
alias comfyui-local='bash /mnt/e/ComfyUI_windows_portable/comfyui_launch_lan.sh --local'
alias comfyui-lan='bash /mnt/e/ComfyUI_windows_portable/comfyui_launch_lan.sh --lan'
alias comfyui-kill='/mnt/c/Windows/System32/taskkill.exe //F //IM python.exe 2>/dev/null || echo "No ComfyUI process found"'
alias comfyui-check='/mnt/c/Windows/System32/netstat.exe -ano | grep ":8188"'
alias comfyui-logs='tail -f "$COMFYUI_ROOT/ComfyUI/user/comfyui.log"'
alias comfyui-dir='cd "$COMFYUI_ROOT"'

# Comes in handy
alias notepad++='/mnt/c/Program\ Files/Notepad++/notepad++.exe'


# Function to get ACTUAL Windows LAN IP (FIXED with full paths)
comfyui-ip() {
    local port="${1:-8188}"
    
    # Get WSL IP (just for reference)
    local wsl_ip=$(hostname -I | awk '{print $1}')
    
    # Get Windows LAN IP using full paths to Windows executables
    local windows_lan_ip=$(/mnt/c/Windows/System32/ipconfig.exe 2>/dev/null | grep -A 5 "Ethernet adapter Ethernet:" | grep "IPv4 Address" | head -1 | cut -d: -f2 | tr -d ' \r')

    # Fallback: try ipconfig parsing with full path
    #if [ -z "$windows_lan_ip" ]; then
    #    windows_lan_ip=$(/mnt/c/Windows/System32/ipconfig.exe | grep -A 3 "Ethernet adapter Ethernet:" | grep "IPv4 Address" | cut -d: -f2 | tr -d ' \r')
    #fi
    
    # Another fallback: parse all ipconfig output for LAN IPs
    if [ -z "$windows_lan_ip" ]; then
        windows_lan_ip=$(/mnt/c/Windows/System32/ipconfig.exe | grep "IPv4 Address" | grep -v "169.254" | grep -v "172.1[6-9]\|172.2[0-9]\|172.3[0-1]" | head -1 | cut -d: -f2 | tr -d ' \r')
    fi
    
    # Final fallback
    if [ -z "$windows_lan_ip" ]; then
        windows_lan_ip="CHECK_IPCONFIG"
    fi
    
    echo ""
    echo "üåê ComfyUI Network Access Information:"
    echo "=========================================="
    echo ""
    echo "üìç Access URLs:"
    echo "   Local (on this PC):  http://localhost:$port"
    if [ "$windows_lan_ip" != "CHECK_IPCONFIG" ]; then
        echo "   Windows LAN IP:      http://$windows_lan_ip:$port  ‚≠ê USE THIS FOR LAN"
        echo ""
        echo "üéØ Share this URL with devices on your LAN:"
        echo "   http://$windows_lan_ip:$port"
    else
        echo "   Windows LAN IP:      Unable to detect automatically"
        echo ""
        echo "‚ùì Run this to find your IP:"
        echo "   /mnt/c/Windows/System32/ipconfig.exe | grep 'IPv4 Address'"
    fi
    echo ""
    echo "‚ÑπÔ∏è  Technical Info:"
    echo "   WSL IP (internal):   $wsl_ip (don't use this for LAN)"
    echo "   Windows LAN IP:      $windows_lan_ip"
    echo ""
    
    if command -v qrencode &> /dev/null; then
    	echo "üì± QR Code for mobile access:"
    	qrencode -t ANSIUTF8 "http://$windows_lan_ip:$port"
    else
    	echo "üì± Install QR code generator: sudo apt install qrencode"
    fi
}

# Quick command to get just the Windows IP
comfyui-windows-ip() {
    # Method 1: Direct ipconfig parsing for Ethernet adapter
    local windows_ip=$(/mnt/c/Windows/System32/ipconfig.exe 2>/dev/null | grep -A 5 "Ethernet adapter Ethernet:" | grep "IPv4 Address" | head -1 | cut -d: -f2 | tr -d ' \r')
    
    # Method 2: Fallback - filter out virtual adapters
    if [ -z "$windows_ip" ]; then
        windows_ip=$(/mnt/c/Windows/System32/ipconfig.exe 2>/dev/null | grep "IPv4 Address" | grep -v "169.254" | grep -v "172.1[6-9]\|172.2[0-9]\|172.3[0-1]" | grep -v "192.168.56" | grep -v "192.168.122" | head -1 | cut -d: -f2 | tr -d ' \r')
    fi
    
    echo "$windows_ip"
}

# Updated test function that uses Windows IP
comfyui-test-lan() {
    local port="${1:-8188}"
    
    echo "üß™ Testing ComfyUI LAN accessibility..."
    echo ""
    
    # Test localhost using netstat instead of curl
    echo "Testing localhost:$port..."
    if /mnt/c/Windows/System32/netstat.exe -ano 2>/dev/null | grep -q "0.0.0.0:$port.*LISTENING"; then
        echo "‚úì ComfyUI is listening on port $port"
    else
        echo "‚ùå ComfyUI is NOT running on port $port"
        echo "   Try: comfyui"
        return 1
    fi
    
    echo ""
    
    # Get Windows IP
    local windows_ip=$(comfyui-windows-ip)
    
    if [ -z "$windows_ip" ]; then
        echo "‚ùå Could not detect Windows IP address"
        return 1
    fi
    
    echo "‚úÖ ComfyUI Status:"
    echo "   Listening: 0.0.0.0:$port (all interfaces)"
    echo "   Windows IP: $windows_ip"
    echo ""
    
    # Show active connections
    local connections=$(/mnt/c/Windows/System32/netstat.exe -ano 2>/dev/null | grep ":$port.*ESTABLISHED" | wc -l)
    if [ $connections -gt 0 ]; then
        echo "üìä Active connections: $connections"
        echo ""
    fi
    
    echo "üåê Access URLs:"
    echo "   Local:   http://localhost:$port"
    echo "   Network: http://$windows_ip:$port"
    echo "   mDNS:    http://mlbox1.local:$port (Safari/Firefox)"
    echo ""
    echo "‚úÖ ComfyUI is accessible on your LAN!"
}

# Function to install ComfyUI requirements
comfyui-pip() {
    if [ -z "$1" ]; then
        echo "Usage: comfyui-pip <package_name>"
        echo "Example: comfyui-pip GitPython"
        return 1
    fi
    "$COMFYUI_PYTHON" -m pip install "$@"
}

# Function to fix the GitPython issue
comfyui-fix-git() {
    echo "Installing GitPython..."
    "$COMFYUI_PYTHON" -m pip install GitPython
    echo "‚úì GitPython installed"
}

# Function to open ComfyUI in browser
comfyui-open() {
    local port="${1:-8188}"
    local url="http://127.0.0.1:$port"
    echo "Opening $url in browser..."
    /mnt/c/Windows/System32/cmd.exe /c start "$url"
}

# Function to check Windows Firewall status (FIXED)
comfyui-firewall-check() {
    echo "üî• Checking Windows Firewall rules for ComfyUI..."
    echo ""
    
    # Try PowerShell first
    /mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -Command "Get-NetFirewallRule -DisplayName '*ComfyUI*' -ErrorAction SilentlyContinue | Select-Object DisplayName, Enabled, Direction, Action | Format-Table -AutoSize" 2>/dev/null
    
    if [ $? -ne 0 ]; then
        echo "Using netsh instead..."
        /mnt/c/Windows/System32/netsh.exe advfirewall firewall show rule name=all | grep -A 5 -i "ComfyUI"
    fi
}

# Function to add Windows Firewall rule for ComfyUI
comfyui-firewall-add() {
    local port="${1:-8188}"
    
    # Check for existing rules first
    local existing=$(/mnt/c/Windows/System32/netsh.exe advfirewall firewall show rule name="ComfyUI Port $port" 2>/dev/null | grep -c "Rule Name")
    
    if [ "$existing" -gt 0 ]; then
        echo "‚ö†Ô∏è  Found $existing existing rule(s) for port $port"
        echo ""
        read -p "Remove duplicates first? (y/n): " choice
        if [[ $choice == "y" || $choice == "Y" ]]; then
            comfyui-firewall-remove $port
            echo ""
        else
            echo "Keeping existing rules and adding another one..."
            echo ""
        fi
    fi
    
    echo "üî• Adding Windows Firewall rule for port $port..."
    echo ""
    
    # Attempt to add firewall rule
    echo "Attempting to add firewall rule..."
    /mnt/c/Windows/System32/netsh.exe advfirewall firewall add rule name="ComfyUI Port $port" dir=in action=allow protocol=TCP localport=$port 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "‚úì Firewall rule added successfully!"
        echo "  Rule name: ComfyUI Port $port"
        echo "  Port: $port"
        echo "  Direction: Inbound"
        echo ""
        comfyui-firewall-check
    else
        echo ""
        echo "‚ùå Failed to add firewall rule (requires administrator privileges)"
        echo ""
        echo "Please run ONE of these commands in Windows:"
        echo ""
        echo "Option 1 - PowerShell (as Administrator):"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "New-NetFirewallRule -DisplayName 'ComfyUI Port $port' -Direction Inbound -Protocol TCP -LocalPort $port -Action Allow"
        echo ""
        echo "Option 2 - Command Prompt (as Administrator):"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "netsh advfirewall firewall add rule name=\"ComfyUI Port $port\" dir=in action=allow protocol=TCP localport=$port"
        echo ""
        echo "Option 3 - Use GUI (Windows Defender Firewall):"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        echo "1. Press Win+R, type 'wf.msc', press Enter"
        echo "2. Click 'Inbound Rules' ‚Üí 'New Rule'"
        echo "3. Select 'Port' ‚Üí TCP ‚Üí Specific local ports: $port"
        echo "4. Allow the connection ‚Üí Name: 'ComfyUI Port $port'"
        echo ""
    fi
}

# Function to remove firewall rule
comfyui-firewall-remove() {
    local port="${1:-8188}"
    echo "üî• Removing Windows Firewall rule for port $port..."
    echo ""
    
    /mnt/c/Windows/System32/netsh.exe advfirewall firewall delete rule name="ComfyUI Port $port"
    
    if [ $? -eq 0 ]; then
        echo "‚úì Firewall rule removed successfully!"
    else
        echo "‚ùå Failed to remove firewall rule or rule doesn't exist."
    fi
}

# Update ComfyUI core
comfyui-update() {
    echo "üîÑ Updating ComfyUI..."
    echo ""
    
    cd "$COMFYUI_ROOT/ComfyUI"
    
    # Check if it's a git repository
    if [ ! -d ".git" ]; then
        echo "‚ùå Not a git repository!"
        return 1
    fi
    
    # Show current status
    echo "Current commit:"
    git --no-pager log -1 --oneline     # ‚Üê Added --no-pager here
    echo ""
    
    # Stash any local changes
    echo "Stashing local changes (if any)..."
    git stash
    echo ""
    
    # Pull updates
    echo "Pulling latest updates from master..."
    git pull origin master
    
    if [ $? -eq 0 ]; then
        # Update frontend package
        echo ""
        echo "Updating frontend package..."
        "$COMFYUI_PYTHON" -m pip install --upgrade comfyui_frontend_package --break-system-packages
        echo ""
        
        echo "‚úÖ ComfyUI updated successfully!"
        echo ""
        echo "New commit:"
        git --no-pager log -1 --oneline     # ‚Üê Added --no-pager here
        echo ""
        
        # Show installed versions
        echo "üì¶ Installed versions:"
        "$COMFYUI_PYTHON" -m pip show comfyui_frontend_package | grep Version
        echo ""
        
        echo "‚ö†Ô∏è  Restart ComfyUI to apply updates:"
        echo "  comfyui-kill"
        echo "  comfyui"
    else
        echo ""
        echo "‚ùå Update failed. Check error messages above."
    fi
    
    cd - > /dev/null
}

# Update all custom nodes that are git repositories
comfyui-update-nodes() {
    echo "üîÑ Updating custom nodes..."
    echo ""
    
    cd "$COMFYUI_ROOT/ComfyUI/custom_nodes"
    
    local updated=0
    local failed=0
    
    # Find all git repositories and update them
    for dir in */; do
        if [ -d "$dir/.git" ]; then
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "üì¶ Updating: ${dir%/}"
            (cd "$dir" && git pull)
            if [ $? -eq 0 ]; then
                ((updated++))
            else
                ((failed++))
            fi
            echo ""
        fi
    done
    
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "‚úÖ Updated: $updated nodes"
    if [ $failed -gt 0 ]; then
        echo "‚ùå Failed: $failed nodes"
    fi
    
    cd - > /dev/null
}

# Check for available updates without applying them
comfyui-check-updates() {
    echo "üîç Checking for ComfyUI updates..."
    echo ""
    
    cd "$COMFYUI_ROOT/ComfyUI"
    
    # Fetch latest without pulling
    git fetch origin master
    
    # Compare
    LOCAL=$(git rev-parse HEAD)
    REMOTE=$(git rev-parse origin/master)
    
    if [ "$LOCAL" = "$REMOTE" ]; then
        echo "‚úÖ ComfyUI is up to date!"
    else
        echo "‚¨ÜÔ∏è  Updates available!"
        echo ""
        echo "Changes:"
        git --no-pager log --oneline HEAD..origin/master     # ‚Üê Added --no-pager here
        echo ""
        echo "Run 'comfyui-update' to update"
    fi
    
    cd - > /dev/null
}

# Auto-completion helper
comfyui-help() {
    cat << 'EOF'
üé® ComfyUI Helper Commands:
---------------------------
LAUNCHING:
  comfyui              - Launch ComfyUI (LAN mode by default)
  comfyui-local        - Launch ComfyUI (localhost only)
  comfyui-lan          - Launch ComfyUI (LAN mode explicitly)
  comfyui --port 8189  - Launch on custom port

MANAGEMENT:
  comfyui-kill         - Kill all Python processes (stops ComfyUI)
  comfyui-check        - Check if port 8188 is in use
  comfyui-logs         - View ComfyUI logs (tail -f)
  comfyui-dir          - Navigate to ComfyUI directory

NETWORK ACCESS:
  comfyui-ip [port]         - Show LAN access URLs
  comfyui-test-lan [port]   - Test if ComfyUI is accessible on LAN
  comfyui-firewall-add      - Add Windows Firewall rule
  comfyui-firewall-remove   - Remove Windows Firewall rule
  comfyui-firewall-check    - Check Windows Firewall rules

UTILITIES:
  comfyui-pip <pkg>    - Install Python package for ComfyUI
  comfyui-fix-git      - Fix the GitPython module error
  comfyui-open [port]  - Open ComfyUI in browser (default: 8188)
  comfyui-help         - Show this help message

QUICK START FOR LAN ACCESS:
---------------------------
1. Fix GitPython:      comfyui-fix-git
2. Add firewall rule:  comfyui-firewall-add
   (If it fails, follow the instructions shown)
3. Launch ComfyUI:     comfyui-lan
4. Get network URL:    comfyui-ip
5. Test access:        comfyui-test-lan

SECURITY NOTE:
-------------
When using LAN mode (0.0.0.0), ComfyUI is accessible from ANY device
on your local network. Only use this on trusted networks!
EOF
}

# Show help on first setup
if [ ! -f ~/.comfyui_setup_done ]; then
    echo ""
    echo "üé® ComfyUI helpers loaded! Type 'comfyui-help' for commands."
    echo ""
    touch ~/.comfyui_setup_done
fi

